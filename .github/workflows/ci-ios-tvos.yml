name: CI (iOS & tvOS)

on:
  pull_request:
    paths:
      - '.github/workflows/ci-ios-tvos.yml'
      - '.github/actions/**'
      - 'package.json'
      - 'yarn.lock'
      - 'ios/**'
      - 'ios/RNBitmovinPlayer.podspec'
      - '.swiftlint.yml'
      - 'example/package.json'
      - 'example/yarn.lock'

  push:
    branches: [development]
    paths:
      - '.github/workflows/ci-ios-tvos.yml'
      - '.github/actions/**'
      - 'package.json'
      - 'yarn.lock'
      - 'ios/**'
      - 'ios/RNBitmovinPlayer.podspec'
      - '.swiftlint.yml'
      - 'example/package.json'
      - 'example/yarn.lock'

concurrency:
  group: ci-ios-tvos-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  code-style-ios:
    name: Code style iOS
    runs-on: macOS-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-environment
        with:
          ios: true
          node: true

      - name: Check code style
        run: yarn lint:ios

  test-build-ios:
    name: Build iOS
    runs-on: macOS-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-environment
        with:
          node: true
          subprojects: true
          ios: true

      - name: Build iOS example
        run: yarn example build:ios --renderer github-actions
        env:
          NSUnbufferedIO: YES

      - name: Build iOS integration test host app
        run: yarn integration-test build:ios --renderer github-actions
        env:
          NSUnbufferedIO: YES

  test-build-tvos:
    name: Build tvOS
    runs-on: macOS-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-environment
        with:
          node: true
          subprojects: true
          ios: true

      - name: Prebuild tvOS example
        run: yarn example prebuild:tv --clean
        env:
          NSUnbufferedIO: YES

      - name: Build tvOS example
        run: yarn example build:tvos --renderer github-actions
        env:
          NSUnbufferedIO: YES
