name: CI (iOS & tvOS)

on:
  push:
    branches:
      - development
    paths:
      - '**/*.ts'
      - '**/*.tsx'
      - '**/*.js'
      - '**/*.json'
      - '**/*.yml'
      - '**/*.yaml'
      - 'ios/**'
      - 'plugin/**'
      - 'example/ios/**'
      - 'example/**/*.ts'
      - 'example/**/*.tsx'
      - 'example/**/*.js'
      - 'example/**/*.json'
      - 'integration_test/ios/**'
      - 'integration_test/**/*.ts'
      - 'integration_test/**/*.tsx'
      - 'integration_test/**/*.js'
      - 'integration_test/**/*.json'
      - '.github/workflows/ci-ios-tvos.yml'
      - '.github/actions/**'
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '**/*.ts'
      - '**/*.tsx' 
      - '**/*.js'
      - '**/*.json'
      - '**/*.yml'
      - '**/*.yaml'
      - 'ios/**'
      - 'plugin/**'
      - 'example/ios/**'
      - 'example/**/*.ts'
      - 'example/**/*.tsx'
      - 'example/**/*.js'
      - 'example/**/*.json'
      - 'integration_test/ios/**'
      - 'integration_test/**/*.ts'
      - 'integration_test/**/*.tsx'
      - 'integration_test/**/*.js'
      - 'integration_test/**/*.json'
      - '.github/workflows/ci-ios-tvos.yml'
      - '.github/actions/**'

concurrency:
  group: ci-ios-tvos-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  ios-tvos-build:
    name: iOS & tvOS Build Suite
    runs-on: macOS-15
    timeout-minutes: 30
    
    env:
      NSUnbufferedIO: YES
      COMMON_BUILD_FLAGS: "-parallelizeTargets -jobs 4 ONLY_ACTIVE_ARCH=YES ARCHS=x86_64 VALID_ARCHS=x86_64 DEBUG_INFORMATION_FORMAT=dwarf COMPILER_INDEX_STORE_ENABLE=NO SWIFT_COMPILATION_MODE=wholemodule ENABLE_TESTABILITY=NO GCC_OPTIMIZATION_LEVEL=0 SWIFT_OPTIMIZATION_LEVEL=-Onone ENABLE_BITCODE=NO"
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-environment
        with:
          node: true
          subprojects: true
          ios: true

      - name: Run Code Style Check
        id: lint
        run: |
          START_TIME=$(date +%s)
          yarn lint:ios
          END_TIME=$(date +%s)
          echo "duration=$((END_TIME - START_TIME))" >> $GITHUB_OUTPUT

      - name: Setup Comprehensive Caching
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/CocoaPods
            example/ios/Pods
            integration_test/ios/Pods
            ~/Library/Developer/Xcode/DerivedData
            example/ios/build
            integration_test/ios/build
          key: ${{ runner.os }}-ios-comprehensive-${{ hashFiles('example/ios/Podfile.lock', 'integration_test/ios/Podfile.lock', 'example/yarn.lock', 'integration_test/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-ios-comprehensive-

      - name: Install CocoaPods Dependencies
        run: |
          yarn example pods
          yarn integration-test pods

      - name: Build iOS Example App (Optimized)
        id: ios-example
        run: |
          START_TIME=$(date +%s)
          yarn example build:ios --renderer github-actions --quiet
          END_TIME=$(date +%s)
          echo "duration=$((END_TIME - START_TIME))" >> $GITHUB_OUTPUT
        env:
          XCODEBUILD_ARGS: "-destination 'generic/platform=iOS Simulator' ${{ env.COMMON_BUILD_FLAGS }}"

      - name: Build iOS Integration Tests (Optimized) 
        id: ios-integration
        run: |
          START_TIME=$(date +%s)
          yarn integration-test build:ios --renderer github-actions --quiet
          END_TIME=$(date +%s)
          echo "duration=$((END_TIME - START_TIME))" >> $GITHUB_OUTPUT
        env:
          XCODEBUILD_ARGS: "-destination 'generic/platform=iOS Simulator' ${{ env.COMMON_BUILD_FLAGS }}"

      - name: Build tvOS Example App (Optimized)
        id: tvos-example
        run: |
          START_TIME=$(date +%s)
          rm -rf example/ios example/android
          yarn example prebuild:tv --clean
          yarn example pods
          yarn example build:tvos --renderer github-actions --quiet
          END_TIME=$(date +%s)
          echo "duration=$((END_TIME - START_TIME))" >> $GITHUB_OUTPUT

      - name: Report Build Performance
        run: |
          echo "## ðŸ“Š iOS & tvOS Build Performance" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Duration |" >> $GITHUB_STEP_SUMMARY  
          echo "|-----------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Style Check | ${{ steps.lint.outputs.duration }}s |" >> $GITHUB_STEP_SUMMARY
          echo "| iOS Example App | ${{ steps.ios-example.outputs.duration }}s |" >> $GITHUB_STEP_SUMMARY
          echo "| iOS Integration Tests | ${{ steps.ios-integration.outputs.duration }}s |" >> $GITHUB_STEP_SUMMARY
          echo "| tvOS Example App | ${{ steps.tvos-example.outputs.duration }}s |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          TOTAL_TIME=$((${{ steps.lint.outputs.duration }} + ${{ steps.ios-example.outputs.duration }} + ${{ steps.ios-integration.outputs.duration }} + ${{ steps.tvos-example.outputs.duration }}))
          echo "**Total Build Time: ${TOTAL_TIME}s**" >> $GITHUB_STEP_SUMMARY

      - name: Upload Build Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ios-tvos-build-outputs
          path: |
            example/ios/build
            integration_test/ios/build
            ~/Library/Developer/Xcode/DerivedData
          retention-days: 1
