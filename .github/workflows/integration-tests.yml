name: Integration Tests

on:
  workflow_dispatch:
    inputs:
      platform:
        description: Target platform(s)
        required: true
        default: both
        type: choice
        options:
          - android
          - ios
          - both

concurrency:
  group: integration-tests-${{ github.event.inputs.platform }}-${{ github.ref }}
  cancel-in-progress: true

env:
  EXPO_PUBLIC_BITMOVIN_PLAYER_LICENSE_KEY: ${{ secrets.INTEGRATION_TESTS_PLAYER_LICENSE_KEY }}

jobs:
  android:
    if: ${{ github.event.inputs.platform != 'ios' }}
    runs-on: ubuntu-latest
    timeout-minutes: 90
    env:
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      ANDROID_HOME: /usr/local/lib/android/sdk
    steps:
      - uses: actions/checkout@v6

      - name: Cache Android Integration Prebuild
        id: android-integration-prebuild-cache
        uses: actions/cache@v4
        with:
          path: |
            integration_test/android
          key: ${{ runner.os }}-android-integration-prebuild-${{ hashFiles('integration_test/yarn.lock', 'integration_test/app.json', 'plugin/**', 'android/**') }}
          restore-keys: |
            ${{ runner.os }}-android-integration-prebuild-

      - name: Cache Gradle Build
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ${{ github.workspace }}/.gradle-ci
            integration_test/android/.gradle
            integration_test/android/app/build
            integration_test/android/build
          key: ${{ runner.os }}-gradle-integration-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'integration_test/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-gradle-integration-
            ${{ runner.os }}-gradle-

      - name: Setup environment
        uses: ./.github/actions/setup-environment
        with:
          node: true
          subprojects: true
          java: true
          skip-prebuild: true

      - name: Configure integration test env
        run: echo "EXPO_PUBLIC_BITMOVIN_PLAYER_LICENSE_KEY=${EXPO_PUBLIC_BITMOVIN_PLAYER_LICENSE_KEY}" > integration_test/.env

      - name: Prebuild Android integration (on cache miss)
        if: ${{ steps.android-integration-prebuild-cache.outputs.cache-hit != 'true' }}
        run: .github/scripts/smart-prebuild.sh integration-test

      - name: Reset adb
        run: |
          $ANDROID_SDK_ROOT/platform-tools/adb kill-server || true
          $ANDROID_SDK_ROOT/platform-tools/adb start-server
          $ANDROID_SDK_ROOT/platform-tools/adb devices

      - name: Run Android integration tests
        id: android-tests
        continue-on-error: true
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          arch: x86_64
          target: google_apis
          force-avd-creation: true
          disable-animations: true
          disable-linux-hw-accel: false
          emulator-options: -no-window -no-snapshot -no-audio -no-boot-anim -no-metrics -gpu swiftshader_indirect
          emulator-boot-timeout: 900
          channel: stable
          ram-size: 2048M
          cores: 2
          script: |
            adb wait-for-device
            for i in $(seq 1 60); do
              if adb shell pm list packages >/dev/null 2>&1; then
                break
              fi
              echo "Waiting for package manager... ($i/60)"
              sleep 5
            done
            yarn integration-test test:android --xml
        env:
          EXPO_PUBLIC_BITMOVIN_PLAYER_LICENSE_KEY: ${{ secrets.INTEGRATION_TESTS_PLAYER_LICENSE_KEY }}

      - name: Collect Android results
        run: |
          if [ -f integration_test/cavy_results.xml ]; then
            mv integration_test/cavy_results.xml integration_test/cavy_results_android.xml
          fi

      - name: Summarize Android results
        if: always()
        env:
          ANDROID_STATUS: ${{ steps.android-tests.outputs.status || '0' }}
        run: |
          python .github/scripts/summarize_cavy_results.py \
            --android integration_test/cavy_results_android.xml

  ios:
    if: ${{ github.event.inputs.platform != 'android' }}
    runs-on: macOS-15
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v6

      - name: Cache iOS Integration Prebuild
        id: ios-integration-prebuild-cache
        uses: actions/cache@v4
        with:
          path: |
            integration_test/ios
          key: ${{ runner.os }}-ios-integration-prebuild-${{ hashFiles('integration_test/yarn.lock', 'integration_test/app.json', 'plugin/**', 'ios/**') }}
          restore-keys: |
            ${{ runner.os }}-ios-integration-prebuild-

      - name: Setup environment
        uses: ./.github/actions/setup-environment
        with:
          node: true
          subprojects: true
          ios: true
          skip-prebuild: true

      - name: Configure integration test env
        run: echo "EXPO_PUBLIC_BITMOVIN_PLAYER_LICENSE_KEY=${EXPO_PUBLIC_BITMOVIN_PLAYER_LICENSE_KEY}" > integration_test/.env

      - name: Prebuild iOS integration (on cache miss)
        if: ${{ steps.ios-integration-prebuild-cache.outputs.cache-hit != 'true' }}
        run: .github/scripts/smart-prebuild.sh integration-test

      - name: Cache CocoaPods Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/CocoaPods
            integration_test/ios/Pods
          key: ${{ runner.os }}-ios-integration-pods-${{ hashFiles('ios/RNBitmovinPlayer.podspec', 'integration_test/ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-ios-integration-pods-

      - name: Install CocoaPods Dependencies
        run: yarn integration-test pods

      - name: Prepare iOS simulator
        run: |
          RUNTIME=$(xcrun simctl list runtimes -j | jq -r '.runtimes | map(select(.platform=="iOS" and .isAvailable==true)) | sort_by(.version) | reverse | .[0].identifier')
          DEVICE=$(xcrun simctl list devicetypes -j | jq -r '.devicetypes | map(select(.name | test("^iPhone"))) | .[0].identifier')
          EXISTING=$(xcrun simctl list devices -j | jq -r --arg rt "$RUNTIME" --arg dt "$DEVICE" '.devices[$rt][] | select(.deviceTypeIdentifier==$dt) | .udid' | head -n 1)
          if [ -z "$EXISTING" ]; then
            EXISTING=$(xcrun simctl create "BitmovinIntegrationTest" "$DEVICE" "$RUNTIME")
          fi
          xcrun simctl boot "$EXISTING" || true
          xcrun simctl bootstatus "$EXISTING" -b

      - name: Run iOS integration tests
        id: ios-tests
        continue-on-error: true
        run: |
          set +e
          yarn integration-test test:ios --xml
          STATUS=$?
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          exit $STATUS

      - name: Collect iOS results
        run: |
          if [ -f integration_test/cavy_results.xml ]; then
            mv integration_test/cavy_results.xml integration_test/cavy_results_ios.xml
          fi

      - name: Summarize iOS results
        if: always()
        env:
          IOS_STATUS: ${{ steps.ios-tests.outputs.status || '0' }}
        run: |
          python .github/scripts/summarize_cavy_results.py \
            --ios integration_test/cavy_results_ios.xml
