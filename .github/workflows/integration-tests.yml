name: Integration Tests

on:
  workflow_dispatch:
    inputs:
      platform:
        description: Target platform(s)
        required: true
        default: both
        type: choice
        options:
          - android
          - ios
          - both

concurrency:
  group: integration-tests-${{ github.event.inputs.platform }}-${{ github.ref }}
  cancel-in-progress: true

env:
  EXPO_PUBLIC_BITMOVIN_PLAYER_LICENSE_KEY: ${{ secrets.INTEGRATION_TESTS_PLAYER_LICENSE_KEY }}

jobs:
  android:
    if: ${{ github.event.inputs.platform != 'ios' }}
    runs-on: ubuntu-latest
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v6

      - name: Cache Android Integration Prebuild
        id: android-integration-prebuild-cache
        uses: actions/cache@v4
        with:
          path: |
            integration_test/android
          key: ${{ runner.os }}-android-integration-prebuild-${{ hashFiles('integration_test/yarn.lock', 'integration_test/app.json', 'plugin/**', 'android/**') }}
          restore-keys: |
            ${{ runner.os }}-android-integration-prebuild-

      - name: Cache Android SDK image
        uses: actions/cache@v4
        with:
          path: |
            /usr/local/lib/android/sdk/platforms/android-34
            /usr/local/lib/android/sdk/system-images/android-34/google_apis/x86_64
            /usr/local/lib/android/sdk/platform-tools
            /home/runner/.android/avd/bitmovin-ci-x86.avd
            /home/runner/.android/avd/bitmovin-ci-x86.ini
          key: ${{ runner.os }}-android-sdk-34-googleapis-x86_64-v1
          restore-keys: |
            ${{ runner.os }}-android-sdk-34-googleapis-x86_64-

      - name: Cache Gradle Build
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ${{ github.workspace }}/.gradle-ci
            integration_test/android/.gradle
            integration_test/android/app/build
            integration_test/android/build
          key: ${{ runner.os }}-gradle-integration-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'integration_test/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-gradle-integration-
            ${{ runner.os }}-gradle-

      - name: Setup environment
        uses: ./.github/actions/setup-environment
        with:
          node: true
          subprojects: true
          java: true
          skip-prebuild: true

      - name: Configure integration test env
        run: echo "EXPO_PUBLIC_BITMOVIN_PLAYER_LICENSE_KEY=${EXPO_PUBLIC_BITMOVIN_PLAYER_LICENSE_KEY}" > integration_test/.env

      - name: Prebuild Android integration (on cache miss)
        if: ${{ steps.android-integration-prebuild-cache.outputs.cache-hit != 'true' }}
        run: .github/scripts/smart-prebuild.sh integration-test

      - name: Prepare Android emulator
        run: |
          export ANDROID_SDK_ROOT=${ANDROID_SDK_ROOT:-/usr/local/lib/android/sdk}
          export ANDROID_HOME=$ANDROID_SDK_ROOT
          export PATH="$ANDROID_HOME/emulator:$ANDROID_HOME/platform-tools:$PATH"
          SYSTEM_IMAGE="system-images;android-34;google_apis;x86_64"
          AVD_NAME="bitmovin-ci-x86"
          yes | "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" --licenses >/dev/null
          "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" --install "platform-tools" "platforms;android-34" "$SYSTEM_IMAGE"
          if ! "$ANDROID_HOME/cmdline-tools/latest/bin/avdmanager" list avd | grep -q "^Name: ${AVD_NAME}$"; then
            echo "no" | "$ANDROID_HOME/cmdline-tools/latest/bin/avdmanager" create avd -n "$AVD_NAME" -k "$SYSTEM_IMAGE" -d pixel_7 --abi x86_64
          fi
          nohup "$ANDROID_HOME/emulator/emulator" -avd "$AVD_NAME" -no-window -no-audio -no-boot-anim -gpu swiftshader_indirect -camera-back none -camera-front none >/tmp/emulator.log 2>&1 &
          adb wait-for-device
          adb shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done;'

      - name: Run Android integration tests
        id: android-tests
        continue-on-error: true
        run: |
          set +e
          yarn integration-test test:android --xml
          STATUS=$?
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          exit $STATUS

      - name: Collect Android results
        run: |
          if [ -f integration_test/cavy_results.xml ]; then
            mv integration_test/cavy_results.xml integration_test/cavy_results_android.xml
          fi

      - name: Summarize Android results
        if: always()
        env:
          ANDROID_STATUS: ${{ steps.android-tests.outputs.status || '0' }}
        run: |
          python .github/scripts/summarize_cavy_results.py \
            --android integration_test/cavy_results_android.xml

  ios:
    if: ${{ github.event.inputs.platform != 'android' }}
    runs-on: macOS-15
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v6

      - name: Cache iOS Integration Prebuild
        id: ios-integration-prebuild-cache
        uses: actions/cache@v4
        with:
          path: |
            integration_test/ios
          key: ${{ runner.os }}-ios-integration-prebuild-${{ hashFiles('integration_test/yarn.lock', 'integration_test/app.json', 'plugin/**', 'ios/**') }}
          restore-keys: |
            ${{ runner.os }}-ios-integration-prebuild-

      - name: Setup environment
        uses: ./.github/actions/setup-environment
        with:
          node: true
          subprojects: true
          ios: true
          skip-prebuild: true

      - name: Configure integration test env
        run: echo "EXPO_PUBLIC_BITMOVIN_PLAYER_LICENSE_KEY=${EXPO_PUBLIC_BITMOVIN_PLAYER_LICENSE_KEY}" > integration_test/.env

      - name: Prebuild iOS integration (on cache miss)
        if: ${{ steps.ios-integration-prebuild-cache.outputs.cache-hit != 'true' }}
        run: .github/scripts/smart-prebuild.sh integration-test

      - name: Cache CocoaPods Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/CocoaPods
            integration_test/ios/Pods
          key: ${{ runner.os }}-ios-integration-pods-${{ hashFiles('ios/RNBitmovinPlayer.podspec', 'integration_test/ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-ios-integration-pods-

      - name: Install CocoaPods Dependencies
        run: yarn integration-test pods

      - name: Prepare iOS simulator
        run: |
          RUNTIME=$(xcrun simctl list runtimes -j | jq -r '.runtimes | map(select(.platform=="iOS" and .isAvailable==true)) | sort_by(.version) | reverse | .[0].identifier')
          DEVICE=$(xcrun simctl list devicetypes -j | jq -r '.devicetypes | map(select(.name | test("^iPhone"))) | .[0].identifier')
          EXISTING=$(xcrun simctl list devices -j | jq -r --arg rt "$RUNTIME" --arg dt "$DEVICE" '.devices[$rt][] | select(.deviceTypeIdentifier==$dt) | .udid' | head -n 1)
          if [ -z "$EXISTING" ]; then
            EXISTING=$(xcrun simctl create "BitmovinIntegrationTest" "$DEVICE" "$RUNTIME")
          fi
          xcrun simctl boot "$EXISTING" || true
          xcrun simctl bootstatus "$EXISTING" -b

      - name: Run iOS integration tests
        id: ios-tests
        continue-on-error: true
        run: |
          set +e
          yarn integration-test test:ios --xml
          STATUS=$?
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          exit $STATUS

      - name: Collect iOS results
        run: |
          if [ -f integration_test/cavy_results.xml ]; then
            mv integration_test/cavy_results.xml integration_test/cavy_results_ios.xml
          fi

      - name: Summarize iOS results
        if: always()
        env:
          IOS_STATUS: ${{ steps.ios-tests.outputs.status || '0' }}
        run: |
          python .github/scripts/summarize_cavy_results.py \
            --ios integration_test/cavy_results_ios.xml
